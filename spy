local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local saymsg = ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents"):WaitForChild("SayMessageRequest")
local getmsg = ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents"):WaitForChild("OnMessageDoneFiltering")

local player = Players.LocalPlayer
local spyEnabled = false
local chatLogs = {}

-- Create GUI
local screenGui = Instance.new("ScreenGui", player.PlayerGui)
screenGui.Name = "ChatSpyGUI"

-- Toggle Button for Chat Spy
local toggleButton = Instance.new("TextButton", screenGui)
toggleButton.Size = UDim2.new(0, 150, 0, 50)
toggleButton.Position = UDim2.new(0.85, 0, 0.1, 0)
toggleButton.Text = "Enable Chat Spy"
toggleButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 18

-- Creator Label
local creatorButton = Instance.new("TextButton", screenGui)
creatorButton.Size = UDim2.new(0, 200, 0, 40)
creatorButton.Position = UDim2.new(0.85, 0, 0.17, 0)
creatorButton.Text = "Created by GodAmirr"
creatorButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
creatorButton.TextColor3 = Color3.fromRGB(255, 255, 0)
creatorButton.Font = Enum.Font.SourceSansBold
creatorButton.TextSize = 16
creatorButton.AutoButtonColor = false  -- Prevents clicking effect

local function logMessage(sender, receiver, msg, isPrivate)
    local senderName = "<font color='rgb(0, 170, 255)'>" .. sender .. "</font>" -- آبی
    local receiverName = receiver and "<font color='rgb(255, 0, 0)'>" .. receiver .. "</font>" or "" -- قرمز (در پیام خصوصی)
    local messageText = isPrivate and (senderName .. " writing to " .. receiverName .. ": " .. msg) or ("[" .. sender .. "]: " .. msg)

    table.insert(chatLogs, messageText)
    StarterGui:SetCore("ChatMakeSystemMessage", {
        Text = isPrivate and "{SPY} " .. sender .. " writing to " .. receiver .. ": " .. msg or "{SPY} [" .. sender .. "]: " .. msg;
        Color = Color3.fromRGB(0, 255, 0);
        Font = Enum.Font.SourceSansBold;
        TextSize = 16;
    })
end

local function onChatted(sender, msg)
    if spyEnabled then
        msg = msg:gsub("[\n\r]", ''):gsub("\t", ' '):gsub("[ ]+", ' ')
        local isPrivate = false
        local receiver = nil

        -- بررسی پیام‌های خصوصی
        local conn = getmsg.OnClientEvent:Connect(function(packet, channel)
            if packet.SpeakerUserId == sender.UserId and packet.Message == msg:sub(#msg - #packet.Message + 1) then
                if packet.RecipientUserId then
                    local recipientPlayer = Players:GetPlayerByUserId(packet.RecipientUserId)
                    if recipientPlayer then
                        receiver = recipientPlayer.Name
                        isPrivate = true
                    end
                end
            end
        end)

        wait(1)
        conn:Disconnect()

        logMessage(sender.Name, receiver, msg, isPrivate)
    end
end

toggleButton.MouseButton1Click:Connect(function()
    spyEnabled = not spyEnabled
    toggleButton.Text = spyEnabled and "Disable Chat Spy" or "Enable Chat Spy"
    StarterGui:SetCore("ChatMakeSystemMessage", {
        Text = "{SPY " .. (spyEnabled and "ENABLED" or "DISABLED") .. "}";
        Color = Color3.fromRGB(255, 255, 0);
        Font = Enum.Font.SourceSansBold;
        TextSize = 18;
    })
end)

for _, p in ipairs(Players:GetPlayers()) do
    p.Chatted:Connect(function(msg) onChatted(p, msg) end)
end

Players.PlayerAdded:Connect(function(p)
    p.Chatted:Connect(function(msg) onChatted(p, msg) end)
end)
